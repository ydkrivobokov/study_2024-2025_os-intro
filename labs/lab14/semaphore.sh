#!/bin/bash


# Проверяем наличие файла-семафора
if [ -f /tmp/resource.lock ]; then
    # Если файл существует, значит ресурс занят
    echo "Ожидание освобождения ресурса (максимум $1 секунд)..."
    
    # Ожидаем освобождения ресурса в течение t1 секунд
    start_time=$(date +%s)  # Запоминаем текущее время в секундах с эпохи UNIX
    while [ -f /tmp/resource.lock ]; do
        # Цикл выполняется, пока существует файл-блокировка
        current_time=$(date +%s)  # Получаем текущее время
        elapsed=$((current_time - start_time))  # Вычисляем прошедшее время
        
        if [ $elapsed -ge $1 ]; then
            # Если время ожидания превысило заданный лимит
            echo "Время ожидания истекло, ресурс не освободился"
            exit 1  # Выходим с ошибкой
        fi
        sleep 1  # Ждем 1 секунду перед следующей проверкой
    done
fi

# Захватываем ресурс
touch /tmp/resource.lock  # Создаем файл-блокировку
echo "Ресурс захвачен процессом $$"  # $$ содержит PID текущего процесса

# Используем ресурс в течение t2 секунд
sleep $2  # Приостанавливаем выполнение на указанное время

# Освобождаем ресурс
rm -f /tmp/resource.lock  # Удаляем файл-блокировку
echo "Ресурс освобожден процессом $$"
